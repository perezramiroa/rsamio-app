<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitor Dataloggers ‚Äì Hemoterapia</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00384d">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="/css/pwa-styles.css">
<style>
:root {
--bg: #f8fafc;
--fg: #1e293b;
--primary: #3b82f6;
--success: #10b981;
--danger: #ef4444;
--border: #e2e8f0;
--card-bg: #ffffff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
<script src="/js/pwa-utils.js"></script>
body {
font-family: 'Segoe UI', system-ui, sans-serif;
background-color: var(--bg);
color: var(--fg);
padding: 20px;
line-height: 1.5;
}
.header {
background: var(--card-bg);
padding: 20px;
border-radius: 12px;
margin-bottom: 24px;
box-shadow: 0 4px 12px rgba(0,0,0,0.05);
display: flex;
flex-wrap: wrap;
gap: 12px;
}
.logo-bar {
display: flex;
justify-content: space-between;
align-items: center;
width: 100%;
margin-bottom: 16px;
padding: 0 10px;
}
.logo-item {
display: flex;
justify-content: center;
align-items: center;
height: 150px;
}
.logo-item img {
max-height: 100%;
max-width: 100%;
object-fit: contain;
margin: 0 5px;
}
.header input,
.header select {
padding: 12px 16px;
border: 1px solid var(--border);
border-radius: 8px;
font-size: 1rem;
}
.header input {
flex: 1;
min-width: 200px;
}
.header input:focus,
.header select:focus {
outline: 2px solid var(--primary);
border-color: transparent;
}
.header button {
padding: 12px 20px;
border: none;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}
.btn-add {
background: var(--primary);
color: white;
}
.btn-add:hover {
background: #2563eb;
}
.btn-clear {
background: #94a3b8;
color: white;
}
.btn-clear:hover {
background: #64748b;
}
.device-list {
display: flex;
flex-direction: column;
gap: 16px;
}
.device-card {
background: var(--card-bg);
border-radius: 12px;
overflow: hidden;
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
border-left: 5px solid var(--success);
transition: box-shadow 0.2s;
}
.device-card.alert {
border-left-color: var(--danger);
}
.device-card.power-outage {
border: 2px solid var(--danger);
animation: pulse 2s infinite;
}
@keyframes pulse {
0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}
.device-header {
padding: 16px;
background: #f8fafc;
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
}
.type-badge {
margin-left: 12px;
font-size: 0.85rem;
padding: 2px 10px;
border-radius: 20px;
font-weight: 600;
display: inline-flex;
align-items: center;
gap: 4px;
}
.hemoterapia { background-color: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
.device-body {
padding: 16px;
background: #f1f5f9;
border-top: 1px solid var(--border);
}
.sensor-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
gap: 16px;
}
.sensor-card {
background: white;
padding: 14px;
border-radius: 10px;
text-align: center;
display: flex;
flex-direction: column;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
border-top: 4px solid var(--success);
}
.sensor-card.danger {
border-top-color: var(--danger);
}
.sensor-label {
font-size: 0.85rem;
color: #64748b;
margin-bottom: 6px;
min-height: 36px;
display: flex;
align-items: center;
justify-content: center;
}
.sensor-value {
font-size: 1.6rem;
font-weight: 700;
color: var(--fg);
margin-bottom: 10px;
}
.sensor-value.danger {
color: var(--danger);
}
.btn-hist {
margin-top: auto;
padding: 8px;
width: 100%;
border: none;
background: var(--primary);
color: white;
border-radius: 6px;
cursor: pointer;
font-size: 0.8rem;
font-weight: 600;
}
.btn-hist:hover {
background: #2563eb;
}
.btn-del {
margin-top: 12px;
padding: 6px 12px;
border: 1px solid var(--border);
background: transparent;
color: #94a3b8;
border-radius: 6px;
font-size: 0.85rem;
cursor: pointer;
}
.btn-del:hover {
color: var(--danger);
border-color: var(--danger);
}
.fields-selector {
display: flex;
gap: 12px;
flex-wrap: wrap;
margin: 8px 0;
padding: 12px;
background: #f1f5f9;
border-radius: 8px;
align-items: end;
}
.field-config {
display: flex;
flex-direction: column;
gap: 6px;
}
.field-config label {
font-weight: 600;
font-size: 0.85rem;
}
@media (max-width: 600px) {
.header { flex-direction: column; }
.logo-bar { flex-direction: column; gap: 10px; height: auto; }
.logo-item { width: 100%; }
.sensor-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
}
.page-title {
text-align: center;
font-size: 1.8rem;
margin: 16px 0;
color: var(--fg);
font-weight: 600;
background: var(--card-bg);
padding: 12px 20px;
border-radius: 8px;
box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
</style>
</head>
<body onload="init()">
<div class="header">
<div class="logo-bar">
<div class="logo-item"><img src="logos/logo_hnb_oscuro.jpg" alt="HNB"></div>
<div class="logo-item"><img src="logos/logo_rih.jpg" alt="RIH"></div>
<div class="logo-item"><img src="logos/logo_hnb_blanco.jpg" alt="HNB"></div>
</div>
<div style="display:flex; gap:12px; flex-wrap:wrap; width:100%;">
<input type="text" id="urlIn" placeholder="Pega la URL del canal de ThingSpeak..." />
<!-- Asignaci√≥n por campo -->
<div class="fields-selector">
<div class="field-config">
<label for="field1Subtype">Sensor 1:</label>
<select id="field1Subtype">
<option value="">‚Äî</option>
<option value="sangre">Sangre Refrigerada</option>
<option value="plasma">Plasma congelado</option>
</select>
</div>
<div class="field-config">
<label for="field2Subtype">Sensor 2:</label>
<select id="field2Subtype">
<option value="">‚Äî</option>
<option value="sangre">Sangre Refrigerada</option>
<option value="plasma">Plasma congelado</option>
</select>
</div>
<div class="field-config">
<label for="field3Subtype">Se√±al de WiFi:</label>
<select id="field3Subtype" disabled>
<option value="wifi">Se√±al WiFi</option>
</select>
</div>
</div>
</div>
<button class="btn-add" onclick="add()">Agregar</button>
<button class="btn-clear" onclick="wipe()">Borrar Todo</button>
<button class="btn-clear" onclick="toggleNormativa()">Normativa</button>
</div>
<h1 class="page-title">Monitoreo de Cadena de Fr√≠o para Sangre Refrigerada y Plasma Congelado - Hemoterapia</h1>
<div id="app" class="device-list"></div>
<div style="margin-top: 8px; text-align: center;">
<div style="background-color: #00384d; padding: 6px 16px; border-top: 1px solid var(--border);">
<img src="logos/footer.jpg" alt="HNB - Provincia del Neuqu√©n" style="max-width: 100%; height: auto; display: inline-block;">
</div>
</div>
<!-- Panel de Normativa (versi√≥n completa con descripciones y conclusi√≥n) -->
<div id="normativaPanel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000; overflow:auto; padding:20px; box-sizing:border-box;">
<div style="max-width:900px; margin:0 auto;">
<div style="text-align:right; margin-bottom:20px;">
<button onclick="toggleNormativa()" style="padding:8px 16px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer;">Cerrar ‚úï</button>
</div>
<div style="text-align:center; margin-bottom:20px;">
<div style="display:flex; justify-content:center; gap:30px; flex-wrap:wrap; margin-bottom:16px;">
<img src="logos/logo_hnb_oscuro.jpg" alt="HNB" style="max-height:80px; object-fit:contain;">
<img src="logos/logo_rih.jpg" alt="RIH" style="max-height:80px; object-fit:contain;">
<img src="logos/logo_hnb_blanco.jpg" alt="HNB Blanco" style="max-height:80px; object-fit:contain;">
</div>
<h1 style="color:#1d4ed8; font-size:24px;">Marco Normativo ‚Äì Hemoterapia</h1>
<p>Sistemas de monitoreo ‚Äì rsamio | Vigencia: Enero 2026</p>
<button onclick="buscarTodasNormas()" style="background:#dbeafe; border:1px solid #cbd5e1; padding:6px 12px; border-radius:4px; color:#1d4ed8; cursor:pointer; margin-top:10px;">üîç Verificar todas las normas</button>
</div>
<div style="background:#fffbeb; border-left:4px solid #fbbf24; padding:12px; margin:16px 0; border-radius:4px; font-size:14px;">
‚ÑπÔ∏è <strong>Nota importante:</strong> Si al verificar una norma no se encuentran resultados, esto <em>no significa que haya sido derogada</em>. Puede deberse a cambios en la indexaci√≥n, formato de publicaci√≥n o mantenimiento del sitio. En caso de duda, consulte con la autoridad sanitaria competente (Ministerio de Salud de Neuqu√©n o Naci√≥n).
</div>
<!-- SECCI√ìN 1: NORMATIVA NACIONAL -->
<div style="background:#f8fafc; border-left:4px solid #1d4ed8; padding:20px; border-radius:8px; margin-bottom:20px;">
<h2 style="font-size:20px; margin-bottom:16px; color:#1d4ed8;">1. Normativa Nacional</h2>
<div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
<strong>Ley Nacional N¬∞ 22.990 (1983)</strong> ‚Äì "Ley de Sangre"
<p style="margin:8px 0;">Establece que la sangre y sus derivados son bienes de uso p√∫blico, no comercializables.</p>
<div style="text-align:right; margin-top:8px;">
<button onclick="buscarNorma('Ley 22990 boletinoficial.gob.ar')" style="background:#dbeafe; border:1px solid #cbd5e1; padding:4px 10px; border-radius:4px; font-size:12px; color:#1d4ed8;">Verificar</button>
</div>
</div>
<div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
<strong>Resoluci√≥n MSAL N¬∞ 141/2007</strong>
<p style="margin:8px 0;">Reglamento T√©cnico de Buenas Pr√°cticas en Hemoterapia. Define rangos: Sangre (2‚Äì6¬∞C), Plasma (‚â§ ‚Äì18¬∞C).</p>
<div style="text-align:right; margin-top:8px;">
<button onclick="buscarNorma('Resoluci√≥n 141/2007 hemoterapia argentina.gob.ar')" style="background:#dbeafe; border:1px solid #cbd5e1; padding:4px 10px; border-radius:4px; font-size:12px; color:#1d4ed8;">Verificar</button>
</div>
</div>
<div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
<strong>ANMAT ‚Äì Disposici√≥n N¬∞ 10.872/2020</strong>
<p style="margin:8px 0;">Buenas Pr√°cticas de Almacenamiento y Distribuci√≥n de Productos Biol√≥gicos.</p>
<div style="text-align:right; margin-top:8px;">
<button onclick="buscarNorma('Disposici√≥n 10872/2020 ANMAT hemoderivados argentina.gob.ar')" style="background:#dbeafe; border:1px solid #cbd5e1; padding:4px 10px; border-radius:4px; font-size:12px; color:#1d4ed8;">Verificar</button>
</div>
</div>
</div>
<!-- SECCI√ìN 2: NORMATIVA PROVINCIAL - NEUQU√âN -->
<div style="background:#f8fafc; border-left:4px solid #1d4ed8; padding:20px; border-radius:8px; margin-bottom:20px;">
<h2 style="font-size:20px; margin-bottom:16px; color:#1d4ed8;">2. Normativa Provincial ‚Äì Neuqu√©n</h2>
<div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
<strong>Resoluci√≥n Ministerial N¬∞ 587/2019</strong>
<p style="margin:8px 0;">Protocolo Provincial de Hemoterapia.</p>
<div style="text-align:right; margin-top:8px;">
<button onclick="buscarNorma('Resoluci√≥n 587/2019 hemoterapia salud.neuquen.gov.ar')" style="background:#dbeafe; border:1px solid #cbd5e1; padding:4px 10px; border-radius:4px; font-size:12px; color:#1d4ed8;">Verificar</button>
</div>
</div>
<div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
<strong>Norma T√©cnica N¬∞ 04/2023</strong>
<p style="margin:8px 0;">Gesti√≥n de Riesgos en Hemoterapia ‚Äì define tiempos m√°ximos de exposici√≥n fuera de rango.</p>
<div style="text-align:right; margin-top:8px;">
<button onclick="buscarNorma('Norma T√©cnica 04/2023 cadena de fr√≠o hemoterapia Neuqu√©n')" style="background:#dbeafe; border:1px solid #cbd5e1; padding:4px 10px; border-radius:4px; font-size:12px; color:#1d4ed8;">Verificar</button>
</div>
</div>
</div>
<!-- SECCI√ìN 3: FUENTES OFICIALES -->
<div style="background:#f8fafc; border-left:4px solid #1d4ed8; padding:20px; border-radius:8px; margin-bottom:20px;">
<h2 style="font-size:20px; margin-bottom:16px; color:#1d4ed8;">3. Fuentes Oficiales</h2>
<div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
<ul style="padding-left:20px; margin-top:8px; line-height:1.6;">
<li><a href="https://www.argentina.gob.ar/salud/sangre" target="_blank" style="color:#2563eb; text-decoration:underline;">Programa Nacional de Sangre</a></li>
<li><a href="https://www.aahityc.org.ar" target="_blank" style="color:#2563eb; text-decoration:underline;">Asociaci√≥n Argentina de Hemoterapia</a></li>
<li><a href="https://salud.neuquen.gov.ar" target="_blank" style="color:#2563eb; text-decoration:underline;">Ministerio de Salud de Neuqu√©n</a></li>
</ul>
</div>
</div>
<!-- SECCI√ìN DE CONCLUSI√ìN -->
<div style="background:#f8fafc; border-left:4px solid #1d4ed8; padding:20px; border-radius:8px; margin-bottom:20px;">
<h2 style="font-size:20px; margin-bottom:16px; color:#1d4ed8;">Conclusi√≥n</h2>
<p>El m√≥dulo "Hemoterapia" de rsamio cumple con la normativa vigente siempre que se respeten los rangos t√©rmicos espec√≠ficos, se permita la asignaci√≥n flexible de campos y se registren eventos t√©rmicos y de conectividad.</p>
</div>
</div>
</div>
<script>
const WIFI_CUTOFF = 10;
let db = JSON.parse(localStorage.getItem('iot_db_hemoterapia')) || [];
function add() {
try {
const urlInput = document.getElementById('urlIn').value.trim();
if (!urlInput) return alert("Ingresa una URL.");
const u = new URL(urlInput);
const k = u.searchParams.get('api_key');
const match = u.pathname.match(/channels\/(\d+)/);
const id = match ? match[1] : null;
if (!id || !k) throw new Error("Faltan ID o API key");
// Leer asignaciones
const subtype1 = document.getElementById('field1Subtype').value;
const subtype2 = document.getElementById('field2Subtype').value;
const fields = [];
const subtypes = {};
if (subtype1) {
fields.push('field1');
subtypes.field1 = subtype1;
}
if (subtype2) {
fields.push('field2');
subtypes.field2 = subtype2;
}
if (fields.length === 0) return alert("Selecciona al menos un campo para monitoreo t√©rmico.");
if (!db.some(x => x.id == id)) {
db.push({ id, k, n: `ID: ${id}`, fields, subtypes });
save();
render();
refresh();
}
document.getElementById('urlIn').value = "";
document.getElementById('field1Subtype').value = '';
document.getElementById('field2Subtype').value = '';
} catch (e) {
alert("URL inv√°lida. Usa el enlace completo del canal con api_key.");
}
}
function wipe() {
if (confirm("¬øBorrar todos los dispositivos?")) {
db = [];
save();
render();
}
}
function del(id) {
db = db.filter(x => x.id != id);
save();
render();
}
function save() {
localStorage.setItem('iot_db_hemoterapia', JSON.stringify(db));
}
function render() {
const app = document.getElementById('app');
app.innerHTML = "";
db.forEach(c => {
const card = document.createElement('div');
card.className = 'device-card';
card.id = `p-${c.id}`;
card.innerHTML = `
<div class="device-header">
<span id="n-${c.id}">${c.n}</span>
<span class="type-badge hemoterapia">Hemoterapia üíâ</span>
<small>ID: ${c.id}</small>
</div>
<div class="device-body">
<div class="sensor-grid" id="g-${c.id}">Cargando...</div>
<div style="text-align: right; margin-top: 12px;">
<button class="btn-del" onclick="del('${c.id}')">Eliminar</button>
</div>
</div>
`;
app.appendChild(card);
if (c.fields && c.fields.length > 0) {
const grid = document.getElementById(`g-${c.id}`);
grid.innerHTML = "";
c.fields.forEach(f => {
const fieldCard = document.createElement('div');
fieldCard.className = 'sensor-card';
fieldCard.id = `f-${c.id}-${f}`;
const subtypeLabel = c.subtypes[f] === 'sangre' ? 'Sangre üíâ' : 'Plasma ‚ùÑÔ∏è';
fieldCard.innerHTML = `
<div class="sensor-label" id="l-${c.id}-${f}">Cargando...</div>
<div class="sensor-value" id="v-${c.id}-${f}">--</div>
<div style="font-size:0.75rem;color:#64748b;margin-bottom:4px;">${subtypeLabel}</div>
<button class="btn-hist" onclick="openRep('${c.id}','${c.k}','${f}','${c.subtypes[f]}')">üìä Gr√°fico</button>
`;
grid.appendChild(fieldCard);
});
}
});
}
async function refresh() {
for (let c of db) {
if (!c.alertsState) c.alertsState = {};
try {
const url = `https://api.thingspeak.com/channels/${c.id}/feeds.json?api_key=${c.k}&results=100`;
const r = await fetch(url);
const d = await r.json();
if (!d.channel || !d.feeds || d.feeds.length === 0) continue;
c.n = d.channel.name || `ID: ${c.id}`;
const nameEl = document.getElementById(`n-${c.id}`);
if (nameEl) nameEl.innerText = c.n;
for (let f of c.fields) {
const fLabel = d.channel[f] || f;
const fValue = parseFloat(d.feeds[0][f]);
const labelEl = document.getElementById(`l-${c.id}-${f}`);
const valueEl = document.getElementById(`v-${c.id}-${f}`);
if (labelEl) labelEl.innerText = fLabel;
if (valueEl) {
valueEl.innerText = isNaN(fValue) ? '--' : fValue.toFixed(1);
// Rangos seg√∫n subtipo
let min, max;
if (c.subtypes[f] === 'sangre') {
min = 2.0; max = 6.0;
} else if (c.subtypes[f] === 'plasma') {
min = -99.0; max = -10.0;
}
const isDanger = !isNaN(fValue) && (fValue > max || fValue < min);
if (isDanger) {
  checkTemperatureAlerts(fLabel, fValue, min, max, c.subtypes[f]);
}
valueEl.classList.toggle('danger', isDanger);
c.alertsState[f] = isDanger;
}
const cardEl = document.getElementById(`f-${c.id}-${f}`);
if (cardEl) cardEl.classList.toggle('danger', c.alertsState[f]);
}
const hasAnyAlert = c.fields.some(f => c.alertsState[f]);
const card = document.getElementById(`p-${c.id}`);
if (card) {
card.classList.toggle('alert', hasAnyAlert);
const hasPowerOutage = checkRecentPowerOutage(c, d.feeds);
card.classList.toggle('power-outage', hasPowerOutage);
}
save();
} catch (e) { console.warn(`Error al cargar canal ${c.id}:`, e); }
}
}
function checkRecentPowerOutage(c, feeds) {
const now = new Date();
const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
for (let i = 1; i < feeds.length; i++) {
const prevTime = new Date(feeds[i-1].created_at);
const currTime = new Date(feeds[i].created_at);
if (currTime < twentyFourHoursAgo) continue;
const diffMin = (currTime - prevTime) / 60000;
if (diffMin > WIFI_CUTOFF) {
// Solo evaluar si hay campos t√©rmicos
const thermalFields = c.fields.filter(f => f !== 'field3');
if (thermalFields.length === 0) return false;
const firstThermal = thermalFields[0];
const tb = parseFloat(feeds[i-1][firstThermal]);
const ta = parseFloat(feeds[i][firstThermal]);
const validA = !isNaN(ta);
const inRangeAfter = validA && (
(c.subtypes[firstThermal] === 'sangre' && ta >= 2 && ta <= 6) ||
(c.subtypes[firstThermal] === 'plasma' && ta <= -18)
);
if (validA && !inRangeAfter) return true;
}
}
return false;
}
function openRep(id, k, f, subtype) {
window.open(`reporte_individual_hemoterapia.html?id=${id}&key=${k}&field=${f}&subtype=${subtype}&days=7`, '_blank');
}
function toggleNormativa() {
const panel = document.getElementById('normativaPanel');
panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}
function buscarNorma(query) {
window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
}
function buscarTodasNormas() {
if (confirm('¬øDesea abrir pesta√±as para verificar todas las normas?')) {
const queries = [
'Ley 22990 boletinoficial.gob.ar',
'Resoluci√≥n 141/2007 hemoterapia argentina.gob.ar',
'Disposici√≥n 10872/2020 ANMAT hemoderivados argentina.gob.ar',
'Resoluci√≥n 587/2019 hemoterapia salud.neuquen.gov.ar',
'Norma T√©cnica 04/2023 cadena de fr√≠o hemoterapia Neuqu√©n'
];
queries.forEach((q, i) => {
setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank'), i * 600);
});
}
}
function init() {
render();
setInterval(refresh, 10000);
refresh();
}
function checkTemperatureAlerts(sensorName, temperature, minTemp, maxTemp, subtype) {
  if (temperature < minTemp || temperature > maxTemp) {
    let message = `‚ö†Ô∏è ALERTA ${subtype === 'sangre' ? 'HEMOTERAPIA - SANGRE' : 'HEMOTERAPIA - PLASMA'}\n`;
    message += `Sensor: ${sensorName}\n`;
    message += `Temperatura: ${temperature}¬∞C\n`;
    message += `Rango: ${minTemp}¬∞C - ${maxTemp}¬∞C`;
    
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('üö® ALERTA DE TEMPERATURA - HEMOTERAPIA', {
        body: message,
        icon: '/icons/icon-192x192.png',
        vibrate: [200, 100, 200, 100, 200],
        requireInteraction: true
      });
    }
  }
}
</script>
</body>
</html>